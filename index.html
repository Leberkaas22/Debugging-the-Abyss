<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debugging the Abyss</title>
  <style>
    :root{
      --bg:#000;
      --transition-fast:180ms ease;
      --transition-med:420ms ease;
      --transition-slow:800ms ease;

      /* Hotspot geometry (viewport %) */
      --center-x:50%; --center-y:50%; --center-w:20%; --center-h:35%;
      --switch-w:6%; --switch-h:25%;
      --switch-gap:3%;
      --switch-x:calc(var(--center-x) - ((var(--center-w) * 0.5) + (var(--switch-w) * 0.5) + var(--switch-gap)));
      --switch-y:50%;

      /* Eyes zone for pupils on bild4 */
      --eyes-x:50%; --eyes-y:42%; --eyes-w:10%; --eyes-h:15%;
      --pupil-move-scale:0.35;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:#fff; overflow-x:hidden;
      user-select:none; -webkit-user-select:none;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    ::selection{ background:transparent; }
    img,.hotspot,#stage{ -webkit-user-drag:none; user-drag:none; user-select:none; -webkit-user-select:none; }
    :focus,.hotspot:focus,.hotspot:active{ outline:none; }

    /* ===== Website One (original) ===== */
    #stage{
      position:fixed; inset:0; display:grid; place-items:center;
      pointer-events:none; z-index:1; transition:opacity 260ms ease;
    }
    .img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      pointer-events:none; will-change:transform,opacity; transition:opacity 220ms ease;
    }
    .hotspot{
      position:fixed; pointer-events:auto; cursor:pointer; z-index:10;
      background:transparent; border:none; outline:none;
    }
    #hotadvance{ display:none !important; }

    #text-layer{ position:absolute; inset:0; z-index:6; pointer-events:none; }
    #text-layer .text-img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      opacity:0; transition:opacity var(--transition-med); will-change:opacity;
    }
    #pupils{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      pointer-events:none; opacity:0; transition:transform 500ms ease, opacity var(--transition-med);
      will-change:transform; z-index:5;
      transform:translate(var(--pupil-offset-x,0px), var(--pupil-offset-y,0px));
    }
    #stein{ position:absolute; inset:0; opacity:0; transition:opacity var(--transition-med); pointer-events:none; z-index:4; }
    #artifact{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) rotate(0deg);
      transform-origin:50% 50%; width:100%; height:100%; opacity:0;
      transition:transform var(--transition-fast), opacity var(--transition-med), top var(--transition-slow);
      pointer-events:none; z-index:3;
    }
    #scroll-space{ position:relative; width:100%; height:0; }

    /* ===== Website Two overlay (iframe) ===== */
    #overlay2{
      position:fixed; inset:0; background:transparent;
      opacity:0; pointer-events:none; z-index:20; transition:opacity 600ms ease;
    }
    #overlay2.active{ opacity:1; pointer-events:auto; }
    #site2frame{ width:100%; height:100%; border:0; display:block; }
  </style>
</head>
<body>
  <!-- Website One -->
  <div id="stage">
    <!-- start.gif instead of bild1.png -->
    <img id="base" class="img" alt="scene" src="start.gif" />
    <img id="stein" class="img" alt="stein" src="stein1.png" />
    <img id="artifact" class="img" alt="artifact" src="" />
    <img id="pupils" alt="pupils" src="bild5.png" />
    <div id="text-layer" aria-hidden="true"></div>
  </div>

  <!-- Hotspots -->
  <div id="hotswitch" class="hotspot" title="Lightswitch"></div>
  <div id="hotcenter" class="hotspot" title="Center"></div>
  <div id="hotadvance" class="hotspot" title="Advance"></div>

  <div id="scroll-space"></div>

  <!-- Website Two (isolated) -->
  <div id="overlay2" aria-hidden="true">
    <iframe id="site2frame" src="site2.html"></iframe>
  </div>

  <script>
    /* ========= tiny helpers ========= */
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const byId = (id)=>document.getElementById(id);

    /* ========= Website One refs ========= */
    const stage = byId('stage');
    const base = byId('base');
    const pupils = byId('pupils');
    const stein = byId('stein');
    const artifact = byId('artifact');
    const textLayer = byId('text-layer');

    const hotSwitch = byId('hotswitch');
    const hotCenter = byId('hotcenter');
    const hotAdvance = byId('hotadvance');
    const scrollSpace = byId('scroll-space');

    /* ========= Overlay (Website Two) refs ========= */
    const overlay2 = byId('overlay2');
    const site2frame = byId('site2frame');
    let overlayActive = false;

    function openOverlay(){
      if (overlayActive) return;
      overlayActive = true;
      overlay2.classList.add('active');
      stage.style.opacity = 0; // hide website 1 layer
      site2frame.contentWindow?.postMessage({type:'site2-reset'}, '*');
    }
    function closeOverlay(){
      if (!overlayActive) return;
      overlayActive = false;
      overlay2.classList.remove('active');
      stage.style.opacity = 1; // show website 1 layer
      site2frame.contentWindow?.postMessage({type:'site2-reset'}, '*');
    }

    function applyHotspotRect(el, cxVar, cyVar, wVar, hVar){
      el.style.left = `calc(var(${cxVar}) - var(${wVar})/2)`;
      el.style.top  = `calc(var(${cyVar}) - var(${hVar})/2)`;
      el.style.width = `var(${wVar})`;
      el.style.height = `var(${hVar})`;
    }
    function updateHotspots(){
      applyHotspotRect(hotSwitch,  '--switch-x','--switch-y','--switch-w','--switch-h');
      applyHotspotRect(hotCenter,  '--center-x','--center-y','--center-w','--center-h');
    }
    window.addEventListener('resize', updateHotspots);

    /* ========= Audio helpers ========= */
    const sounds = {};

    function loadSound(key, src){
      try{
        const audio = new Audio(src);
        audio.preload = 'auto';
        sounds[key] = audio;
      } catch(_){}
    }

    function playSound(key){
      const base = sounds[key];
      if(!base) return;
      try{
        if (key === 'steen') {
          // SPECIAL: allow overlapping steen sounds, always play fully
          const a = base.cloneNode();
          a.play().catch(()=>{});
        } else {
          // default behavior: restart same audio
          base.currentTime = 0;
          base.play().catch(()=>{});
        }
      } catch(_){}
    }

    // preload sounds
    loadSound('licht', 'licht.mp3');    // light switch
    loadSound('tweek', 'tweek.mp3');    // hover variant 1
    loadSound('tweek2', 'tweek2.mp3');  // hover variant 2
    loadSound('woosh', 'woosh.mp3');    // scroll sequence here (if you keep it)
    loadSound('steen', 'steen.mp3');    // clicking stein1/stein2

    /* ========= Website One state ========= */
    const Phase = {
      Bild1:'bild1', Bild2:'bild2', Bild3:'bild3', Bild4:'bild4',
      ClickRotate:'click-rotate', ScrollSeq:'scroll-seq', Bild12:'bild12'
    };
    let phase = Phase.Bild1;

    function setBase(src){ base.src = src; }
    function setBaseWithFade(src, onVisible){
      const cur = (base.currentSrc||base.src||'').split('/').pop();
      if (cur === src){ stage.style.opacity = 1; onVisible && onVisible(); return; }
      base.style.opacity = 0;
      let done = false;
      const finish = ()=>{
        if(done) return;
        done = true;
        requestAnimationFrame(()=>{ base.style.opacity=1; onVisible&&onVisible(); });
      };
      const pre = new Image();
      pre.onload = ()=>{ base.src = src; finish(); };
      pre.onerror= ()=>{ base.src = src; finish(); };
      pre.src = src;
      setTimeout(()=>{ if(!done){ base.src = src; finish(); } }, 900);
    }
    function showPupils(b){ pupils.style.opacity = b?'1':'0'; }
    function showStein(b){ stein.style.opacity = b?'1':'0'; }
    function showArtifact(b){ artifact.style.opacity = b?'1':'0'; }
    function setArtifact(src){ if(src) artifact.src = src; }
    function setArtifactTransform(deg, translateYvh){
      const tY = (translateYvh ?? 0);
      artifact.style.transform = `translate(-50%, -50%) translateY(${tY}vh) rotate(${deg}deg)`;
    }
    function ensureTextEl(src){
      let el = textLayer.querySelector(`img[data-key="${src}"]`);
      if(!el){
        el = document.createElement('img');
        el.className='text-img'; el.dataset.key=src; el.alt=src;
        textLayer.appendChild(el);
      }
      return el;
    }
    function showText(src){
      const el = ensureTextEl(src);
      if(!el.getAttribute('src')) el.src = src;
      requestAnimationFrame(()=> el.style.opacity='1');
    }
    function hideText(src){
      const el = textLayer.querySelector(`img[data-key="${src}"]`);
      if(!el) return;
      el.style.opacity = '0';
      const onEnd = (e)=>{
        if(e.propertyName==='opacity'){
          el.removeEventListener('transitionend', onEnd);
          el.remove();
        }
      };
      el.addEventListener('transitionend', onEnd);
    }
    function clearTexts(){ textLayer.innerHTML=''; }
    function showGifFresh(src){
      const old = textLayer.querySelector(`img[data-key="${src}"]`);
      if(old) old.remove();
      const el = document.createElement('img');
      el.className='text-img'; el.dataset.key=src; el.alt=src;
      el.src = src + '?t=' + Math.floor(performance.now());
      textLayer.appendChild(el);
      requestAnimationFrame(()=> el.style.opacity='1');
    }

    function isOnBild1(){
      const name = (base.currentSrc||base.src||'').split('/').pop().toLowerCase();
      // treat start.gif as the initial bild1 state
      return name.startsWith('start') || name.startsWith('bild1');
    }

    /* ===== Eye tracking (Bild4) ===== */
    let bild4Timer=null, pupilsCenterTimer=null, pupilsFrozen=false;

    function getEyesZoneRect(){
      const s = getComputedStyle(document.documentElement);
      const vw = window.innerWidth, vh = window.innerHeight;
      const cx = parseFloat(s.getPropertyValue('--eyes-x'))/100 * vw;
      const cy = parseFloat(s.getPropertyValue('--eyes-y'))/100 * vh;
      const w  = parseFloat(s.getPropertyValue('--eyes-w'))/100 * vw;
      const h  = parseFloat(s.getPropertyValue('--eyes-h'))/100 * vh;
      return { left: cx - w/2, top: cy - h/2, right: cx + w/2, bottom: cy + h/2 };
    }
    function updatePupilsPosition(clientX, clientY){
      if(phase !== Phase.Bild4 || pupilsFrozen) return;
      const r = getEyesZoneRect();
      const cx = (r.left + r.right) / 2;
      const cy = (r.top  + r.bottom) / 2;
      const rangeX = (r.right - r.left) / 2;
      const rangeY = (r.bottom - r.top) / 2;
      const rawX = Math.max(-rangeX, Math.min(rangeX, clientX - cx));
      const rawY = Math.max(-rangeY, Math.min(rangeY, clientY - cy));
      const factor = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pupil-move-scale')) || 0.35;
      pupils.style.setProperty('--pupil-offset-x', (rawX*factor) + 'px');
      pupils.style.setProperty('--pupil-offset-y', (rawY*factor) + 'px');
    }
    window.addEventListener('pointermove', e=>updatePupilsPosition(e.clientX, e.clientY), {passive:true});
    window.addEventListener('mousemove',   e=>updatePupilsPosition(e.clientX, e.clientY), {passive:true});

    /* ===== Website One click flow ===== */
    let stoneToggle=false, clickSteps=0;
    let text5Shown=false, text6Shown=false, text66Shown=false, text77Shown=false, text7Shown=false;
    let tweekToggle=false; // toggles between tweek and tweek2

    document.addEventListener('click', ()=>{
      if (phase === Phase.ClickRotate) {
        // sound for clicking stein1/stein2 (overlapping)
        playSound('steen');

        stoneToggle = !stoneToggle;
        stein.src = stoneToggle ? 'stein2.png' : 'stein1.png';
        showStein(true);
        clickSteps += 1;
        const deg = (clickSteps * 15) % 360;
        setArtifactTransform(deg, 0);

        if(!text5Shown && clickSteps >= 12){
          showText('text5.png');
          text5Shown=true;
        }

        if (clickSteps % 24 === 0) {
          showStein(false);
          hideText('text4.png');
          hideText('text5.png');

          const prev = artifact.style.transition;
          artifact.style.transition = 'transform 360ms ease, opacity var(--transition-med), top var(--transition-slow)';
          setArtifact('bild7.png');
          requestAnimationFrame(()=> setArtifactTransform(0, -20));
          const restore = (e)=>{
            if(e.propertyName==='transform'){
              artifact.style.transition = prev || 'transform var(--transition-fast), opacity var(--transition-med), top var(--transition-slow)';
              artifact.removeEventListener('transitionend', restore);
            }
          };
          artifact.addEventListener('transitionend', restore);

          phase = Phase.ScrollSeq;
          scrollSpace.style.height = '8000px';
          scrollStartY = window.scrollY;
          intervalIndex = 0;

          if(!text6Shown){
            showText('text6.png');
            text6Shown=true;
          }
        }
      }
    });

    const FRAME_ORDER = ['bild7.png','bild8.png','bild9.png','bild10.png'];
    const SCROLL_DEG_PER_PX = 0.25;
    let scrollStartY=0, intervalIndex=0;

    window.addEventListener('scroll', ()=>{
      if(phase !== Phase.ScrollSeq) return;
      const deltaPx = Math.max(0, window.scrollY - scrollStartY);
      const totalDeg = deltaPx * SCROLL_DEG_PER_PX;

      let localIndex = Math.min(3, Math.floor(totalDeg / 120));
      let localDeg   = totalDeg - (localIndex * 120);

      if(localIndex !== intervalIndex){
        intervalIndex = localIndex;
        const nextSrc = FRAME_ORDER[Math.min(intervalIndex, FRAME_ORDER.length-1)];
        setArtifact(nextSrc);

        // sound after every section scrolled past (unchanged)
        playSound('woosh');

        if(nextSrc==='bild8.png'  && !text66Shown){ showText('text66.png'); text66Shown=true; }
        if(nextSrc==='bild9.png'  && !text77Shown){ showText('text77.png'); text77Shown=true; }
        if(nextSrc==='bild10.png' && !text7Shown ){ showText('text7.png');   text7Shown=true; }
      }

      const baseline = -20 + (Math.min(intervalIndex, 3) * 10);
      const tY = baseline + (clamp(localDeg / 120, 0, 1) * 10);

      const absDeg = (intervalIndex * 120) + localDeg;
      setArtifactTransform(absDeg, tY);

      if(totalDeg >= 480 && !artifact.src.endsWith('bild11.png')){
        setArtifact('bild11.png');
      }
      if(totalDeg >= 480){
        const extraDown = (totalDeg - 480) / 2;
        setArtifactTransform(absDeg, tY + extraDown);
        if(tY + extraDown > 140){ enterBild12(); }
      }
    }, { passive:true });

    function enterBild12(){
      if(phase === Phase.Bild12) return;
      phase = Phase.Bild12;

      base.style.transition = 'none';
      base.style.transform = 'translateY(100vh)';
      base.style.opacity = 0;
      setBase('bild12.gif');

      requestAnimationFrame(()=>{
        base.style.transition = 'transform 700ms ease, opacity 420ms ease';
        base.style.opacity = 1;
        base.style.transform = 'translateY(0)';
        const cleanup = (e)=>{
          if(e.propertyName === 'transform'){
            base.style.transition = 'opacity 220ms ease';
            base.style.transform = '';
            base.removeEventListener('transitionend', cleanup);
          }
        };
        base.addEventListener('transitionend', cleanup);
      });

      artifact.style.opacity = 0;
      pupils.style.opacity = 0;

      clearTexts();
      showText('text8.png');

      scrollSpace.style.height = '1200px';

      hotSwitch.style.pointerEvents = 'auto';
      hotCenter.style.pointerEvents = 'none';
    }

    /* Hotspot behaviors */
    function onBild1(){ return phase===Phase.Bild1 && isOnBild1(); }

    hotSwitch.addEventListener('click', ()=>{
      // sound on light switch
      playSound('licht');

      if (overlayActive) closeOverlay();

      if(phase === Phase.Bild1){
        setBaseWithFade('bild2.gif');
        phase = Phase.Bild2;
        hotCenter.style.pointerEvents = 'auto';
        showText('text1.png');
      } else if(phase === Phase.Bild12){
        resetAll();
      }
    });

    hotCenter.addEventListener('mouseenter', ()=>{
      if (phase === Phase.Bild2) {
        setBaseWithFade('bild3.gif');
        phase = Phase.Bild3;
        showText('text2.png');

        // sound when bild2 -> bild3 on hover, switching between tweek and tweek2
        playSound(tweekToggle ? 'tweek2' : 'tweek');
        tweekToggle = !tweekToggle;
      }
    });

    hotCenter.addEventListener('mouseleave', ()=>{
      if (phase === Phase.Bild3 || phase === Phase.Bild2) {
        setBaseWithFade('bild2.gif');
        phase = Phase.Bild2;
      }
    });

    hotCenter.addEventListener('click', ()=>{
      if (overlayActive) closeOverlay();
      if (phase === Phase.Bild3) {
        hideText('text1.png');
        hideText('text2.png');

        setBaseWithFade('bild4.gif', ()=>{
          if (phase === Phase.Bild4) { showGifFresh('text3.gif'); }
        });

        phase = Phase.Bild4;
        showPupils(true);

        if (bild4Timer) clearTimeout(bild4Timer);
        if (pupilsCenterTimer) clearTimeout(pupilsCenterTimer);

        pupilsCenterTimer = setTimeout(()=>{
          pupilsFrozen = true;
          pupils.style.setProperty('--pupil-offset-x','0px');
          pupils.style.setProperty('--pupil-offset-y','0px');
        }, 4000);

        bild4Timer = setTimeout(()=>{
          hideText('text3.gif');
          showPupils(false);
          base.style.opacity = 0;

          stoneToggle = false;
          stein.src = 'stein1.png';
          showStein(true);

          setArtifact('bild6.png');
          showArtifact(true);
          setArtifactTransform(0, 0);
          phase = Phase.ClickRotate;

          showText('text4.png');
        }, 5000);
      }
    });

    function resetAll(){
      try { if (bild4Timer) { clearTimeout(bild4Timer); bild4Timer=null; } } catch(_){}
      try { if (pupilsCenterTimer) { clearTimeout(pupilsCenterTimer); pupilsCenterTimer=null; } } catch(_){}
      pupilsFrozen=false;

      phase = Phase.Bild1;
      stage.style.opacity = 1;
      // reset to start.gif
      setBase('start.gif');

      closeOverlay();

      hotSwitch.style.pointerEvents = 'auto';
      hotCenter.style.pointerEvents = 'none';

      showPupils(false);
      pupils.style.setProperty('--pupil-offset-x','0px');
      pupils.style.setProperty('--pupil-offset-y','0px');

      stoneToggle=false; stein.src='stein1.png'; showStein(false);
      setArtifact(''); showArtifact(false);
      artifact.style.top='50%';
      setArtifactTransform(0,0);
      artifact.style.transition = 'transform var(--transition-fast), opacity var(--transition-med), top var(--transition-slow)';

      clearTexts();
      text5Shown=false; text6Shown=false; text66Shown=false; text77Shown=false; text7Shown=false;

      tweekToggle=false;
      clickSteps=0;
      scrollSpace.style.height='0px';
      scrollStartY=0; intervalIndex=0;

      try { window.scrollTo({ top:0, behavior:'auto' }); } catch(_){}
      updateHotspots();
    }

    // init
    resetAll();

    window.addEventListener('wheel', ()=>{
      if (!overlayActive && onBild1()) openOverlay();
    }, { passive:true });

    window.addEventListener('keydown', (e)=>{
      if (!onBild1()) return;
      if (e.key==='Escape'){ closeOverlay(); return; }
      if (!overlayActive && (e.key==='ArrowDown' || e.key==='s' || e.key==='S' || e.key==='PageDown' || e.key===' ')){
        openOverlay();
      }
    });

    let touchY=null;
    window.addEventListener('touchstart', e=>{
      if (!onBild1() || overlayActive) return;
      touchY = e.touches[0].clientY;
    }, {passive:true});
    window.addEventListener('touchmove', ()=>{
      if (!overlayActive && onBild1()) openOverlay();
    }, {passive:true});
    window.addEventListener('touchend', ()=>{ touchY=null; }, {passive:true});

    window.addEventListener('message', (ev)=>{
      const data = ev.data || {};
      if (data.type === 'site2-progress'){
        if (overlayActive && data.virtual <= 0.5){ closeOverlay(); }
      } else if (data.type === 'site2-exit'){
        closeOverlay();
      }
    });
  </script>
</body>
</html>
